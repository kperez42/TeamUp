rules_version = '2';

// Firebase Storage Security Rules for Celestia
// Deploy with: firebase deploy --only storage

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidImageSize() {
      return request.resource.size < 10 * 1024 * 1024; // 10MB max
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    // Profile images - users can only upload to their own folder
    match /profile_images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isEmailVerified()
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Signup photos - users can upload during account creation (before email verification)
    // This path is used by AuthService.createUser for initial profile photos
    match /users/{userId}/photos/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Gallery photos - users can upload to their own gallery (for profile editing)
    match /gallery_photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Chat images - users can upload to match folders they're part of
    // Match documents use user1Id and user2Id fields, not a participants array
    match /chat_images/{matchId}/{fileName} {
      allow read: if isAuthenticated()
                  && (request.auth.uid == firestore.get(/databases/(default)/documents/matches/$(matchId)).data.user1Id
                      || request.auth.uid == firestore.get(/databases/(default)/documents/matches/$(matchId)).data.user2Id);
      allow write: if isAuthenticated()
                   && (request.auth.uid == firestore.get(/databases/(default)/documents/matches/$(matchId)).data.user1Id
                       || request.auth.uid == firestore.get(/databases/(default)/documents/matches/$(matchId)).data.user2Id)
                   && isEmailVerified()
                   && isValidImageSize()
                   && isValidImage();
    }

    // Verification photos - temporary storage for photo verification
    match /verification_photos/{userId}/{fileName} {
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminRole());
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isEmailVerified()
                   && isValidImageSize()
                   && isValidImage();
      // Auto-delete after 7 days (handled by Cloud Function)
    }

    // Manual ID verification uploads (ID photo + selfie for admin review)
    match /verification/{userId}/{fileName} {
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminRole());
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isEmailVerified()
                   && isValidImageSize()
                   && isValidImage();
    }

    // Admin role check helper (requires custom claims)
    function hasAdminRole() {
      return request.auth.token.admin == true;
    }

    // Admin uploads for app assets, marketing materials, etc.
    match /admin/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && hasAdminRole();
    }

    // Deny all other access - security by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
